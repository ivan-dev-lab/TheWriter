# AGENTS.md — Техническое задание (ТЗ) для Codex

## 0) Контекст и цель
Нужно настольное **GUI-приложение на Python** с **приятным, но строгим** интерфейсом **в светлой теме**, которое позволяет пользователю **просматривать, создавать и редактировать торговые планы**.  
Торговые планы хранятся на диске как **Markdown-файлы (.md)**. Во время редактирования обязателен **автосейв**.

Главный фокус: **красивый интерфейс**, удобная работа с директориями, надежное сохранение и редактирование планов.

---

## 1) Пользовательские сценарии (User Stories)
1. Пользователь выбирает папку с торговыми планами и видит список `.md` файлов.
2. Пользователь открывает план — видит его содержимое по блокам и может редактировать.
3. Пользователь создаёт новый план по шаблону из 3 блоков и сохраняет в выбранную папку.
4. Пользователь редактирует план — изменения **автоматически сохраняются**.
5. Пользователь может «Сохранить как…» в **указанную директорию**.
6. Пользователь может быстро просматривать планы (поиск/фильтр по названию, если несложно).

---

## 2) Объектная модель и формат данных

### 2.1 Что такое торговый план
Торговый план состоит из **трёх смысловых блоков** (разделов):

1. **Описание текущей ситуации**
2. **Описание сценариев перехода к сделкам**
3. **Описание сценариев сделок**

### 2.2 Формат файла `.md` (обязательный шаблон)
Файл должен быть валидным Markdown и содержать ровно эти секции (заголовки H2, порядок важен):

```md
# <Название плана>

## 1. Описание текущей ситуации
<текст...>

## 2. Описание сценариев перехода к сделкам
<текст...>

## 3. Описание сценариев сделок
<текст...>
```

#### Допущения/правила парсинга
- Если файл содержит дополнительные разделы — приложение должно **сохранить их**, но обязательно показывать и редактировать ключевые 3 блока.
- Если заголовки не найдены — показывать текст целиком в режиме «сырой Markdown», и предлагать «Нормализовать в шаблон» (опционально, но желательно).
- При сохранении:
  - Заголовки и порядок 3 блоков должны сохраняться.
  - Внутри блоков разрешён любой Markdown (списки, жирный, ссылки, код, таблицы).

---

## 3) Требования к интерфейсу (UI/UX)

### 3.1 Общий стиль
- **Светлая тема по умолчанию**, строгая и аккуратная (не кислотная).
- Современная типографика (читабельный шрифт), адекватные отступы, аккуратные иконки.
- Минимализм: панели/кнопки только по делу.
- Отображать статус: «Открыт файл», «Автосохранение: ✓», «Последнее сохранение: HH:MM:SS».

### 3.2 Основное окно (рекомендуемая компоновка)
- **Левая панель (sidebar)**:
  - Текущая папка с планами.
  - Список `.md` файлов (название, возможно дата изменения).
  - Поиск/фильтр по названию (по возможности).
- **Центральная область**:
  - Редактор плана по блокам: три вкладки или три секции с заголовками + многострочные поля.
  - Желательно: режим «Split view» — слева редактор, справа Markdown-превью (опционально, но очень полезно).
- **Верхняя панель (toolbar/меню)**:
  - Открыть папку
  - Новый план
  - Сохранить / Сохранить как…
  - Обновить список
- **Строка состояния (status bar)**:
  - Путь к текущему файлу
  - Индикатор автосейва
  - Предупреждения/ошибки

### 3.3 Поведение при навигации
- При переключении между файлами:
  - Если есть несохранённые изменения (в теории автосейв должен их уже сохранить) — убедиться, что данные сохранены.
- При удалении/перезаписи:
  - Минимальная защита от потери данных: подтверждение, либо хранить резервную копию.

---

## 4) Функциональные требования

### 4.1 Управление директориями
- Пользователь может:
  - Выбрать директорию с планами (через диалог).
  - Видеть список `.md` файлов в директории.
  - Открывать файл двойным кликом/кнопкой.
- Приложение должно запоминать последнюю открытую директорию (в настройках/конфиге).

### 4.2 Просмотр и редактирование
- После открытия файла:
  - Парсить его на 3 блока по заголовкам `## 1...`, `## 2...`, `## 3...`.
  - Показать каждый блок в отдельном редакторе (три поля).
- Возможность редактировать текст внутри каждого блока.

### 4.3 Создание нового плана
- Кнопка «Новый план»:
  - Запрашивает название плана (можно в модальном окне).
  - Создаёт новый документ по шаблону.
  - По умолчанию сохраняет в текущую выбранную директорию (или предлагает выбрать директорию, если не выбрана).

### 4.4 Сохранение
- «Сохранить» — сохраняет в текущий файл.
- «Сохранить как…» — позволяет выбрать директорию и имя файла.
- При сохранении:
  - Обновлять заголовок `# <Название плана>` (если пользователь меняет название — решаемо через отдельное поле Title или берём из имени файла).
  - Обновлять статус в UI.

### 4.5 Автосохранение (обязательно)
Требования:
- Автосейв должен происходить:
  - **после паузы** в наборе текста (debounce), например 800–1500 мс, и/или
  - периодически, например раз в 10–30 секунд при наличии изменений.
- Автосейв:
  - Не должен подвешивать UI (использовать таймер и аккуратные операции записи).
  - Должен быть безопасным: писать через временный файл и атомарную замену (write → flush → rename).
- Для нового плана без имени/пути:
  - Автосейв сохраняет в **черновик** (например `_draft_YYYYMMDD_HHMMSS.md`) в выбранной директории.
  - Если директория ещё не выбрана — хранить во временном файле в user data dir и просить выбрать директорию при первом явном «Сохранить как…».

---

## 5) Нефункциональные требования

### 5.1 Технологии
- Язык: Python 3.11+ (или 3.10+, если нужно шире).
- GUI: **PySide6 (Qt6)** предпочтительно для «красивого интерфейса».
  - Использовать Qt Stylesheets/QPalette для светлой темы.
  - Иконки: встроенные или SVG-пак.
- Markdown-превью (опционально, но желательно):
  - Рендеринг через `markdown` + отображение в `QTextBrowser`/`QWebEngineView` (если доступен).
  - Если `QtWebEngine` тяжёлый — допускается простое превью в QTextBrowser.

### 5.2 Хранение настроек
- Сохранять в `~/.config/<appname>/settings.json` (или через QSettings).
- Минимум: последняя директория, список последних файлов (опционально), настройки автосейва (опционально).

### 5.3 Кроссплатформенность
- Должно работать на Windows / macOS / Linux (минимально Windows + macOS желательно).
- Код не должен зависеть от платформенных путей напрямую.

### 5.4 Надежность и защита от потери данных
- Запись на диск только через безопасный механизм:
  - записать во временный файл рядом (например `.filename.md.tmp`),
  - затем атомарно заменить основной файл.
- При ошибке записи показать понятное уведомление (toast/dialog) и не потерять текст в UI.

---

## 6) Архитектура (рекомендуемая)
- `app/`
  - `main.py` — вход
  - `ui/` — окна/виджеты
  - `core/`
    - `plans.py` — модель плана, парсинг/сборка Markdown
    - `storage.py` — чтение/запись, атомарное сохранение, черновики
    - `autosave.py` — логика debounce/таймеров
  - `settings.py` — настройки приложения

Принцип: UI отдельно от логики парсинга/хранения.

---

## 7) Детали реализации

### 7.1 Парсинг Markdown на блоки
- Вход: строка markdown.
- Выход:
  - title (из первого `# ...`, если есть)
  - block1, block2, block3 (текст после соответствующих `##` до следующего `##`)
  - remainder/extras (всё остальное, если нужно сохранить)
- При сохранении обратно:
  - Собрать файл в стандартный шаблон, аккуратно добавив extras (если они были).

### 7.2 Список планов в папке
- Сканировать директорию (не рекурсивно) по маске `*.md`.
- Сортировка по:
  - сначала по времени изменения (desc) или по имени (asc) — выбрать один и зафиксировать.
- Поиск/фильтр: фильтровать список без повторного чтения с диска.

### 7.3 Автосейв debounce
- На любое изменение текста помечать документ как dirty и перезапускать таймер debounce.
- По таймеру:
  - если есть путь файла → сохранить атомарно
  - если нет → сохранить черновик
- В UI показывать:
  - «Автосохранение…» во время записи
  - «✓» после успеха + время
  - ошибку, если не удалось (без закрытия приложения)

---

## 8) Минимальные критерии готовности (Acceptance Criteria)
- Приложение запускается и показывает светлый аккуратный интерфейс.
- Пользователь может выбрать папку и увидеть `.md` планы.
- Пользователь может открыть план, видеть 3 блока и редактировать их.
- Сохранение работает:
  - «Сохранить» сохраняет в исходный файл,
  - «Сохранить как…» сохраняет в выбранную директорию.
- Автосейв работает и реально пишет изменения на диск без зависаний.
- Файлы сохраняются в `.md` формате по заданному шаблону.
- Ошибки чтения/записи показываются пользователю понятным сообщением.

---

## 9) Опциональные улучшения (если остаётся время)
- Markdown-превью справа (split view).
- «Недавние папки/файлы».
- Подсветка Markdown в редакторе (хотя бы базовая).
- Горячие клавиши: Ctrl+N, Ctrl+S, Ctrl+Shift+S, Ctrl+O (папка).
- Резервные копии: при сохранении делать `.bak` в скрытой подпапке.

---

## 10) Инструкции Codex/агенту (что именно сделать)
1. Создать проект на Python с PySide6.
2. Реализовать главное окно с компоновкой: sidebar со списком файлов + центральная область с 3 редакторами блоков.
3. Реализовать выбор директории и загрузку списка `.md`.
4. Реализовать парсер/сборщик Markdown по шаблону из 3 секций.
5. Реализовать сохранение и «сохранить как…» (атомарная запись).
6. Реализовать автосейв (debounce) + индикаторы статуса.
7. Добавить минимальные тесты для парсинга/сборки (pytest) или хотя бы самопроверку.
8. Убедиться, что приложение не падает на «кривом» Markdown и корректно сообщает об ошибках.

Конец.
